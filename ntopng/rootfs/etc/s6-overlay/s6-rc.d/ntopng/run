#!/command/with-contenv bashio
# shellcheck disable=SC2191
# ==============================================================================
# Li Tin O've Weedle Add-on: ntopng
# Runs the ntopNG
# ==============================================================================
declare -a options

# Wait for Redis service to start
bashio::log.info "Waiting for Redis service to start..."
s6-svwait -u -t 5000 /run/service/redis
if [ $? -ne 0 ]; then
    bashio::log.fatal "Redis service failed to start in time, terminating."
    exit 1
fi

# Wait for Netflow2NG service to start
bashio::log.info "Waiting for Netflow2NG service to start..."
s6-svwait -u -t 5000 /run/service/netflow2ng
if [ $? -ne 0 ]; then
    bashio::log.fatal "Netflow2NG service failed to start in time, terminating."
    exit 1
fi

# Wait for GeoIP service to start
bashio::log.info "Waiting for GeoIP service to start..."
s6-svwait -u -t 5000 /run/service/geoip
if [ $? -ne 0 ]; then
    bashio::log.fatal "GeoIP service failed to start in time, terminating."
    exit 1
fi


# Wait for geoipupdate update to finish
if bashio::fs.file_exists /etc/GeoIP.conf; then
    bashio::log.info "ntopng is waiting until GeoIP update database."
    for i in {300..0}; do
        if bashio::fs.file_exists /var/run/geoip/finished; then
            bashio::log.info "GeoIP database is ready."
            break;
        fi
        sleep 1
    done
    if [ "$i" -eq 0 ]; then
        bashio::log.warning "ntopng is done waiting for GeoIP database update. Starting anyway."
    fi
fi

# Wait for Redis to become available
bashio::net.wait_for "$(bashio::config 'redis_loc_port')" localhost 900
if [ $? -eq 0 ]; then
    for i in {300..0}; do
        if [ `redis-cli -h 127.0.0.1 -p $(bashio::config 'redis_loc_port') PING` == "PONG" ]; then
            bashio::log.info "Redis is available."
            break;
        fi
        sleep 1
    done
    if [ "$i" -eq 0 ]; then
        bashio::log.fatal "Can't connect to Redis server, terminating."
        exit 1
    fi
else
    bashio::log.fatal "Redis service is not available in time, terminating."
    exit 1
fi

# Wait for Netflow2NG to become available
bashio::net.wait_for "$(bashio::config 'zmq_loc_port')" localhost 900
if [ $? -eq 0 ]; then
    bashio::log.info "Netflow2NG is available."
else
    bashio::log.fatal "Netflow2NG service is not available, terminating."
    exit 1
fi

bashio::log.info 'Starting ntopng...'

options+=(--interface="zmq://127.0.0.1:$(bashio::config 'zmq_loc_port')")
options+=(--data-dir=/data/data)
options+=(--pcap-dir=/data/pcap)
options+=(--geoip-dir=/data/geoip)
options+=(--pid=/var/run/ntopng/ntopng.pid)
options+=(--http-port="127.0.0.1:$(bashio::config 'ntopng_loc_port')")
options+=(--https-port=0)
options+=(--http-prefix="/ntopng_prefix")
options+=(--instance-name="homeassistant.local")
options+=(--user=root)

if bashio::config.true 'custom_scripts'; then
    options+=(--scripts-dir=/data/scripts)
    options+=(--callbacks-dir=/data/scripts/callbacks)
fi

if bashio::config.false 'ntop_auth'; then
    if bashio::config.true 'leave_front_door_open' && bashio::var.has_value "$(bashio::addon.port 80)"; then
        bashio::log.warning
        bashio::log.warning "Direct access mode is enabled"
        bashio::log.warning "and both HA access authentication"
        bashio::log.warning "and ntop application is disabled!"
        bashio::log.warning
        bashio::log.warning "Anyone will have access to ntop!"
        bashio::log.warning
    fi
    options+=(--disable-login=1)
#    options+=(--disable-autologout)
fi

if $(bashio::config.has_value 'dns_mode'); then
    options+=(--dns-mode="$(bashio::config 'dns_mode')")
fi

if $(bashio::config.has_value 'dump_flows'); then
    options+=(--dump-flows="$(bashio::config 'dump_flows')")
fi

if $(bashio::config.has_value 'local_net'); then
    nets=""
    for net in $(bashio::config 'local_net'); do
        nets+=$net","
    done
    options+=(--local-networks="${nets%,}")
fi

# Find the matching ntopng log level
if bashio::config.has_value 'log_level'; then
    case "$(bashio::string.lower "$(bashio::config 'log_level')")" in
        all|trace|debug)
            options+=(--verbose=6)
            ;;
        info)
            options+=(--verbose=3)
            ;;
        notice)
            options+=(--verbose=2)
            ;;
        warning)
            options+=(--verbose=1)
            ;;
        error|fatal|off)
            options+=(--verbose=0)
            ;;
    esac
fi

bashio::log.info "ntopng ${options[@]}"

# Run ntopng
exec ntopng "${options[@]}"

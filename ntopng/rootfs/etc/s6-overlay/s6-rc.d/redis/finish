#!/command/with-contenv bashio
# ==============================================================================
# Li Tin O've Weedle Addons
# ==============================================================================
declare exit_code
readonly exit_code_container=$(</run/s6-linux-init-container-results/exitcode)
readonly exit_code_service="${1}"
readonly exit_code_signal="${2}"
readonly service="redis"

bashio::log.info \
  "Service ${service} exited with code ${exit_code_service}" \
  "(by signal ${exit_code_signal})"

if [[ "${exit_code_service}" -eq 256 ]]; then
  if [[ "${exit_code_container}" -eq 0 ]]; then
    echo $((128 + $exit_code_signal)) > /run/s6-linux-init-container-results/exitcode
  fi
  # Allow SIGTERM to restart instead of halting container
  if [[ "${exit_code_signal}" -eq 15 ]]; then
    bashio::log.warning "Service ${service} received SIGTERM, restarting instead of halting container..."
  fi
elif [[ "${exit_code_service}" -ne 0 ]]; then
  if [[ "${exit_code_container}" -eq 0 ]]; then
    echo "${exit_code_service}" > /run/s6-linux-init-container-results/exitcode
  fi
  # Do not halt container on redis failure, just restart the service
  bashio::log.warning "Service ${service} failed, restarting instead of halting container..."
else
  bashio::log.info "Service ${service} restarting..."
fi

#!/command/with-contenv bashio
# ==============================================================================
# Li Tin O've Weedle Add-on: ntopng
# Runs the redis daemon
# ==============================================================================
declare -a options

# Check if there is any redis running on the system
bashio::net.wait_for "$(bashio::config 'redis_loc_port')" localhost 1000
if [ $? -eq 0 ]; then
    bashio::log.info "Redis configured port $(bashio::config 'redis_loc_port') is already open."
    bashio::log.info "Testing if this is a valid redis server which can be used by addon."
    if [ `redis-cli -h 127.0.0.1 -p $(bashio::config 'redis_loc_port') PING` == "PONG" ]; then
        bashio::log.notice "Running redis server was found, addon will use it instead of internal Redis server."
        exec sleep infinity
    else
        bashio::log.fatal "Some process already run on the configured redis port $(bashio::config 'redis_loc_port')."
        bashio::log.fatal "It doesn't seem to be a valid redis server or addon can not connect to it."
        bashio::log.fatal "Please fix the configuration or stop the other process before starting the addon."
        exit 1
    fi
fi   

bashio::log.info "Starting redis..."

options+=(--bind 127.0.0.1)
options+=(--port "$(bashio::config 'redis_loc_port')")
options+=(--daemonize no)
options+=(--dir /data/redis)
options+=(--logfile "")

# Find the matching ntopng log level
if bashio::config.has_value 'log_level'; then
    case "$(bashio::string.lower "$(bashio::config 'log_level')")" in
        all|trace|debug)
            options+=(--loglevel debug)
            ;;
        info)
            options+=(--loglevel verbose)
            ;;
        notice)
            options+=(--loglevel notice)
            ;;
        warning|error|fatal)
            options+=(--loglevel warning)
            ;;
        off)
            options+=(--loglevel warning)
            options+=(">/dev/null 2>&1")
            ;;
    esac
fi

bashio::log.info "redis-server /etc/redis/redis.conf ${options[@]}"

exec redis-server /etc/redis/redis.conf "${options[@]}"
